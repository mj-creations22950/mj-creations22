"""
Script to initialize the database with sample data
"""
import asyncio
from motor.motor_asyncio import AsyncIOMotorClient
from dotenv import load_dotenv
import os
from pathlib import Path
import json

# Load environment
ROOT_DIR = Path(__file__).parent
load_dotenv(ROOT_DIR / '.env')

mongo_url = os.environ['MONGO_URL']
db_name = os.environ['DB_NAME']

async def init_database():
    client = AsyncIOMotorClient(mongo_url)
    db = client[db_name]
    
    print("üöÄ Initializing MJ Cr√©ations database...")
    
    # Create admin user
    admin_exists = await db.users.find_one({"email": "admin@mjcreations.fr"})
    if not admin_exists:
        from auth import hash_password
        from utils import get_current_timestamp
        import uuid
        
        admin_user = {
            "id": str(uuid.uuid4()),
            "email": "admin@mjcreations.fr",
            "full_name": "Admin MJ Cr√©ations",
            "phone": "0123456789",
            "role": "admin",
            "hashed_password": hash_password("admin123"),
            "is_active": True,
            "loyalty_points": 0,
            "addresses": [],
            "created_at": get_current_timestamp()
        }
        await db.users.insert_one(admin_user)
        print("‚úÖ Admin user created: admin@mjcreations.fr / admin123")
    else:
        print("‚ÑπÔ∏è  Admin user already exists")
    
    # Create sample services
    services_count = await db.services.count_documents({})
    if services_count == 0:
        from utils import get_current_timestamp
        import uuid
        
        sample_services = [
            # Plomberie
            {
                "id": str(uuid.uuid4()),
                "category": "Plomberie",
                "sub_category": "Installation",
                "name": "Installation robinet",
                "description": "Installation compl√®te d'un robinet",
                "price": 89.0,
                "unit": "unit√©",
                "included": ["Fourniture du robinet", "Installation", "Test d'√©tanch√©it√©"],
                "excluded": ["Modifications de la tuyauterie existante"],
                "duration_hours": 1.5,
                "is_active": True,
                "image_url": None
            },
            {
                "id": str(uuid.uuid4()),
                "category": "Plomberie",
                "sub_category": "R√©paration",
                "name": "D√©bouchage canalisation",
                "description": "D√©bouchage professionnel de canalisation",
                "price": 120.0,
                "unit": "intervention",
                "included": ["Diagnostic", "D√©bouchage", "Nettoyage"],
                "excluded": ["Remplacement de canalisation"],
                "duration_hours": 1.0,
                "is_active": True,
                "image_url": None
            },
            # Chauffage
            {
                "id": str(uuid.uuid4()),
                "category": "Chauffage",
                "sub_category": "Entretien",
                "name": "Entretien chaudi√®re",
                "description": "Entretien annuel de chaudi√®re gaz",
                "price": 150.0,
                "unit": "intervention",
                "included": ["Nettoyage complet", "V√©rification s√©curit√©", "Attestation"],
                "excluded": ["Pi√®ces de rechange"],
                "duration_hours": 2.0,
                "is_active": True,
                "image_url": None
            },
            {
                "id": str(uuid.uuid4()),
                "category": "Chauffage",
                "sub_category": "Installation",
                "name": "Installation radiateur",
                "description": "Installation d'un radiateur √©lectrique",
                "price": 180.0,
                "unit": "unit√©",
                "included": ["Installation", "Raccordement √©lectrique", "Mise en service"],
                "excluded": ["Fourniture du radiateur"],
                "duration_hours": 2.5,
                "is_active": True,
                "image_url": None
            },
            # √âlectricit√©
            {
                "id": str(uuid.uuid4()),
                "category": "√âlectricit√©",
                "sub_category": "Installation",
                "name": "Installation prise √©lectrique",
                "description": "Installation d'une prise √©lectrique murale",
                "price": 75.0,
                "unit": "unit√©",
                "included": ["Fourniture de la prise", "Installation", "Test"],
                "excluded": ["Saign√©e dans le mur"],
                "duration_hours": 1.0,
                "is_active": True,
                "image_url": None
            },
            {
                "id": str(uuid.uuid4()),
                "category": "√âlectricit√©",
                "sub_category": "D√©pannage",
                "name": "D√©pannage √©lectrique d'urgence",
                "description": "Intervention d'urgence pour panne √©lectrique",
                "price": 95.0,
                "unit": "intervention",
                "included": ["Diagnostic", "R√©paration simple"],
                "excluded": ["Remplacement tableau √©lectrique"],
                "duration_hours": 1.5,
                "is_active": True,
                "image_url": None
            },
            # VMC
            {
                "id": str(uuid.uuid4()),
                "category": "VMC",
                "sub_category": "Installation",
                "name": "Installation VMC simple flux",
                "description": "Installation compl√®te d'une VMC simple flux",
                "price": 890.0,
                "unit": "installation",
                "included": ["Fourniture VMC", "Installation", "Raccordement", "Mise en service"],
                "excluded": ["Gaines de ventilation suppl√©mentaires"],
                "duration_hours": 6.0,
                "is_active": True,
                "image_url": None
            },
            {
                "id": str(uuid.uuid4()),
                "category": "VMC",
                "sub_category": "Entretien",
                "name": "Entretien VMC",
                "description": "Entretien et nettoyage de VMC",
                "price": 120.0,
                "unit": "intervention",
                "included": ["Nettoyage filtres", "V√©rification moteur", "Nettoyage bouches"],
                "excluded": ["Remplacement pi√®ces"],
                "duration_hours": 1.5,
                "is_active": True,
                "image_url": None
            }
        ]
        
        await db.services.insert_many(sample_services)
        print(f"‚úÖ {len(sample_services)} sample services created")
    else:
        print(f"‚ÑπÔ∏è  {services_count} services already in database")
    
    # Create system config
    config_exists = await db.system_config.find_one({"key": "travel_fee"})
    if not config_exists:
        from utils import get_current_timestamp
        import uuid
        
        configs = [
            {
                "id": str(uuid.uuid4()),
                "key": "travel_fee",
                "value": 50.0,
                "description": "Frais de d√©placement par d√©faut",
                "updated_at": get_current_timestamp()
            },
            {
                "id": str(uuid.uuid4()),
                "key": "loyalty_rate",
                "value": 0.01,
                "description": "Taux de fid√©lit√© (1% par d√©faut)",
                "updated_at": get_current_timestamp()
            },
            {
                "id": str(uuid.uuid4()),
                "key": "quote_validity_days",
                "value": 30,
                "description": "Validit√© des devis en jours",
                "updated_at": get_current_timestamp()
            }
        ]
        await db.system_config.insert_many(configs)
        print("‚úÖ System configuration created")
    else:
        print("‚ÑπÔ∏è  System configuration already exists")
    
    print("\n‚ú® Database initialization complete!")
    print("\nüìù Admin credentials:")
    print("   Email: admin@mjcreations.fr")
    print("   Password: admin123")
    print("\n‚ö†Ô∏è  Please change the admin password after first login!")
    
    client.close()

if __name__ == "__main__":
    asyncio.run(init_database())
